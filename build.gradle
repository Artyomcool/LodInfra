plugins {
    id 'java'
    id 'application'
    id 'com.palantir.graal' version '0.10.0'
    id 'org.openjfx.javafxplugin' version '0.0.13'
    id "org.beryx.jlink" version "2.24.1"
}

group 'com.github.artyomcool'
version '1.0-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(11)
    }
    modularity.inferModulePath = true
}

compileJava {
    options.compilerArgs.addAll([
            '--add-exports',
            'javafx.graphics/com.sun.javafx.stage=ALL-UNNAMED',

            '--add-exports',
            'javafx.graphics/com.sun.javafx.application=ALL-UNNAMED',

            '--add-exports',
            'javafx.graphics/com.sun.javafx.scene.traversal=ALL-UNNAMED',

            '--add-exports',
            'javafx.graphics/com.sun.glass.utils=ALL-UNNAMED',

            '--add-exports',
            'javafx.graphics/com.sun.glass.ui=ALL-UNNAMED',

            '--add-exports',
            'javafx.controls/com.sun.javafx.scene.control.behavior=ALL-UNNAMED',

            '--add-exports',
            'javafx.controls/com.sun.javafx.scene.control.inputmap=ALL-UNNAMED',

            '--add-exports',
            'org.controlsfx.controls/impl.org.controlsfx.skin=ALL-UNNAMED'
    ])
}

repositories {
    mavenCentral()
}

dependencies {
    implementation('org.apache.poi:poi:4.1.2') {
        exclude group: 'org.apache.logging.log4j'
    }
    implementation('org.apache.poi:poi-ooxml:4.1.2') {
        exclude group: 'org.apache.logging.log4j'
    }
    implementation 'org.apache.commons:commons-text:1.9'
    implementation 'ar.com.hjg:pngj:2.1.0'

    implementation 'org.graalvm.nativeimage:svm:22.0.0.2'

    implementation 'com.google.code.gson:gson:2.8.9'
    implementation 'org.controlsfx:controlsfx:11.1.1'
    implementation 'com.jfoenix:jfoenix:9.0.10'

    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.1'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.1'
}

javafx {
    version = '11'
    modules = ['javafx.graphics','javafx.controls']
}

application {
    mainClass = 'com.github.artyomcool.lodinfra.Pack'
    applicationDefaultJvmArgs = [
            '--add-opens',
            'javafx.base/com.sun.javafx.runtime=ALL-UNNAMED',
            '--add-opens',
            'javafx.controls/com.sun.javafx.scene.control.behavior=ALL-UNNAMED',
            '--add-opens',
            'javafx.controls/com.sun.javafx.scene.control=ALL-UNNAMED',
            '--add-opens',
            'javafx.base/com.sun.javafx.binding=ALL-UNNAMED',
            '--add-opens',
            'javafx.base/com.sun.javafx.event=ALL-UNNAMED',
            '--add-opens',
            'javafx.graphics/com.sun.javafx.stage=ALL-UNNAMED'
    ]
}

graal {
    graalVersion '22.0.0.2'
    outputName 'pack'

    mainClass 'com.github.artyomcool.lodinfra.Pack'

    javaVersion '11'
    option '--no-fallback'
    option '--allow-incomplete-classpath'
    option '-H:+AddAllCharsets'
    option '--features=com.github.artyomcool.lodinfra.NativeImage'
    option '-H:IncludeResources=(.*\\.css)'
    option '-H:+ReportExceptionStackTraces'
    option '--verbose'
    option '-J-Xmx16G'
}

test {
    useJUnitPlatform()
}

jlink {
    //imageZip = file("$buildDir/image-zip/hellofx.zip")
    options = ['--bind-services', '--strip-debug', '--compress', '2', '--no-header-files', '--no-man-pages']

    launcher {
        name = 'helloFX'
        noConsole = true
    }
    mergedModule {
        requires 'jdk.internal.vm.compiler';
        requires 'java.logging';
        requires 'java.xml';
        requires 'java.desktop';
        requires 'java.security.jgss';
        requires 'jdk.unsupported';
        requires 'jdk.management';
        requires 'java.xml.crypto';
        requires 'java.management';
        requires 'java.scripting';
        requires 'jdk.internal.vm.ci';
        requires 'org.graalvm.truffle';
        requires 'org.graalvm.sdk';
        requires 'jdk.javadoc';
        requires 'java.instrument';
        uses 'org.graalvm.nativeimage.Platform';
        uses 'org.graalvm.compiler.options.OptionDescriptors';
        uses 'com.oracle.svm.hosted.agent.NativeImageBytecodeInstrumentationAgentExtension';
        uses 'com.oracle.truffle.api.instrumentation.TruffleInstrument.Provider';
        uses 'com.oracle.svm.core.c.libc.LibCBase';
        uses 'com.oracle.truffle.api.TruffleLanguage.Provider';
        uses 'com.oracle.svm.hosted.NativeImageClassLoaderPostProcessing';
        provides 'com.oracle.svm.hosted.NativeImageClassLoaderPostProcessing' with 'com.oracle.svm.hosted.NativeImageClassLoaderOptions.ApplyNativeImageClassLoaderOptions';
        provides 'org.graalvm.compiler.options.OptionDescriptors' with 'com.oracle.graal.pointsto.api.PointstoOptions_OptionDescriptors',
                'com.oracle.graal.pointsto.phases.InlineBeforeAnalysis_OptionDescriptors',
                'com.oracle.graal.pointsto.reports.AnalysisReportsOptions_OptionDescriptors',
                'com.oracle.svm.common.option.CommonOptions_OptionDescriptors',
                'com.oracle.svm.core.Containers_OptionDescriptors',
                'com.oracle.svm.core.FallbackExecutor_OptionDescriptors',
                'com.oracle.svm.core.RuntimeAssertionsSupport_OptionDescriptors',
                'com.oracle.svm.core.SubstrateDiagnostics_OptionDescriptors',
                'com.oracle.svm.core.SubstrateGCOptions_OptionDescriptors',
                'com.oracle.svm.core.SubstrateOptions_OptionDescriptors',
                'com.oracle.svm.core.SubstrateSegfaultHandler_OptionDescriptors',
                'com.oracle.svm.core.VMInspectionOptions_OptionDescriptors',
                'com.oracle.svm.core.allocationprofile.AllocationSite_OptionDescriptors',
                'com.oracle.svm.core.code.CodeInfoDecoder_OptionDescriptors',
                'com.oracle.svm.core.code.CodeInfoEncoder_OptionDescriptors',
                'com.oracle.svm.core.code.CodeInfoTable_OptionDescriptors',
                'com.oracle.svm.core.code.RuntimeCodeCache_OptionDescriptors',
                'com.oracle.svm.core.configure.ConfigurationFiles_OptionDescriptors',
                'com.oracle.svm.core.deopt.DeoptimizationCounters_OptionDescriptors',
                'com.oracle.svm.core.deopt.Deoptimizer_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.BasicCollectionPolicies_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.CollectionPolicy_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.GreyToBlackObjRefVisitor_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.GreyToBlackObjectVisitor_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.HeapChunk_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.HeapOptions_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.HeapParameters_OptionDescriptors',
                'com.oracle.svm.core.genscavenge.graal.BarrierSnippets_OptionDescriptors',
                'com.oracle.svm.core.graal.snippets.DeoptTester_OptionDescriptors',
                'com.oracle.svm.core.hub.PredefinedClassesSupport_OptionDescriptors',
                'com.oracle.svm.core.jdk.FileSystemProviderSupport_OptionDescriptors',
                'com.oracle.svm.core.jdk.JRTSupport_OptionDescriptors',
                'com.oracle.svm.core.jdk.ProtectionDomainSupport_OptionDescriptors',
                'com.oracle.svm.core.jdk.TimeZoneFeature_OptionDescriptors',
                'com.oracle.svm.core.posix.linux.libc.LibCFeature_OptionDescriptors',
                'com.oracle.svm.core.stack.StackOverflowCheck_OptionDescriptors',
                'com.oracle.svm.core.thread.Safepoint_OptionDescriptors',
                'com.oracle.svm.core.thread.ThreadingSupportImpl_OptionDescriptors',
                'com.oracle.svm.graal.SubstrateGraalUtils_OptionDescriptors',
                'com.oracle.svm.graal.hosted.GraalFeature_OptionDescriptors',
                'com.oracle.svm.hosted.FeatureHandler_OptionDescriptors',
                'com.oracle.svm.hosted.LoggingFeature_OptionDescriptors',
                'com.oracle.svm.hosted.NativeImageClassLoaderOptions_OptionDescriptors',
                'com.oracle.svm.hosted.NativeImageOptions_OptionDescriptors',
                'com.oracle.svm.hosted.ResourcesFeature_OptionDescriptors',
                'com.oracle.svm.hosted.SVMHost_OptionDescriptors',
                'com.oracle.svm.hosted.SecurityServicesFeature_OptionDescriptors',
                'com.oracle.svm.hosted.ServiceLoaderFeature_OptionDescriptors',
                'com.oracle.svm.hosted.SubstitutionReportFeature_OptionDescriptors',
                'com.oracle.svm.hosted.c.CAnnotationProcessorCache_OptionDescriptors',
                'com.oracle.svm.hosted.classinitialization.ClassInitializationOptions_OptionDescriptors',
                'com.oracle.svm.hosted.code.RestrictHeapAccessAnnotationChecker_OptionDescriptors',
                'com.oracle.svm.hosted.code.UninterruptibleAnnotationChecker_OptionDescriptors',
                'com.oracle.svm.hosted.dashboard.DashboardOptions_OptionDescriptors',
                'com.oracle.svm.hosted.diagnostic.HostedHeapDumpFeature_OptionDescriptors',
                'com.oracle.svm.hosted.fieldfolding.StaticFinalFieldFoldingFeature_OptionDescriptors',
                'com.oracle.svm.hosted.image.CCLinkerInvocation_OptionDescriptors',
                'com.oracle.svm.hosted.image.NativeImageCodeCache_OptionDescriptors',
                'com.oracle.svm.hosted.jdk.localization.LocalizationFeature_OptionDescriptors',
                'com.oracle.svm.hosted.phases.InlineBeforeAnalysisPolicyImpl_OptionDescriptors',
                'com.oracle.svm.hosted.snippets.ReflectionPlugins_OptionDescriptors',
                'com.oracle.svm.hosted.snippets.SubstrateGraphBuilderPlugins_OptionDescriptors',
                'com.oracle.svm.hosted.substitute.UnsafeAutomaticSubstitutionProcessor_OptionDescriptors',
                'com.oracle.svm.jni.access.JNIAccessFeature_OptionDescriptors',
                'com.oracle.svm.truffle.TruffleFeature_OptionDescriptors',
                'com.oracle.svm.truffle.api.SubstrateTruffleOptions_OptionDescriptors',
                'com.oracle.svm.util.ImageBuildStatistics_OptionDescriptors';
        provides 'java.nio.file.spi.FileSystemProvider' with 'com.oracle.svm.core.jdk.resources.NativeImageResourceFileSystemProvider';
        provides 'com.oracle.svm.hosted.agent.NativeImageBytecodeInstrumentationAgentExtension' with 'com.oracle.svm.hosted.agent.jdk8.NativeImageBytecodeInstrumentationAgentJDK8';
        provides 'com.oracle.svm.core.c.libc.LibCBase' with 'com.oracle.svm.core.posix.linux.libc.BionicLibC',
                'com.oracle.svm.core.posix.linux.libc.GLibC',
                'com.oracle.svm.core.posix.linux.libc.MuslLibC';
        provides 'org.graalvm.compiler.nodes.graphbuilderconf.GeneratedPluginFactory' with 'com.oracle.svm.core.PluginFactory_CalleeSavedRegisters',
                'com.oracle.svm.core.PluginFactory_FrameAccess',
                'com.oracle.svm.core.PluginFactory_IsolateArgumentParser',
                'com.oracle.svm.core.PluginFactory_IsolateListenerSupport',
                'com.oracle.svm.core.PluginFactory_ReservedRegisters',
                'com.oracle.svm.core.PluginFactory_RuntimeAssertionsSupport',
                'com.oracle.svm.core.PluginFactory_SubstrateDiagnostics',
                'com.oracle.svm.core.PluginFactory_SubstrateOptions',
                'com.oracle.svm.core.PluginFactory_SubstrateSegfaultHandler',
                'com.oracle.svm.core.PluginFactory_SubstrateUtil',
                'com.oracle.svm.core.PluginFactory_VMInspection',
                'com.oracle.svm.core.aarch64.PluginFactory_AArch64FrameAccess',
                'com.oracle.svm.core.amd64.PluginFactory_AMD64FrameAccess',
                'com.oracle.svm.core.c.libc.PluginFactory_LibCBase',
                'com.oracle.svm.core.classinitialization.PluginFactory_EnsureClassInitializedNode',
                'com.oracle.svm.core.classinitialization.PluginFactory_EnsureClassInitializedSnippets',
                'com.oracle.svm.core.code.PluginFactory_CodeInfoAccess',
                'com.oracle.svm.core.code.PluginFactory_CodeInfoDecoder',
                'com.oracle.svm.core.code.PluginFactory_CodeInfoTable',
                'com.oracle.svm.core.code.PluginFactory_ReferenceAdjuster',
                'com.oracle.svm.core.code.PluginFactory_RuntimeCodeInfoAccess',
                'com.oracle.svm.core.code.PluginFactory_RuntimeCodeInfoHistory',
                'com.oracle.svm.core.code.PluginFactory_RuntimeCodeInfoMemory',
                'com.oracle.svm.core.config.PluginFactory_ConfigurationValues',
                'com.oracle.svm.core.config.PluginFactory_ObjectLayout',
                'com.oracle.svm.core.deopt.PluginFactory_DeoptimizationCounters',
                'com.oracle.svm.core.deopt.PluginFactory_DeoptimizationSupport',
                'com.oracle.svm.core.genscavenge.PluginFactory_AbstractCollectionPolicy',
                'com.oracle.svm.core.genscavenge.PluginFactory_AlignedHeapChunk',
                'com.oracle.svm.core.genscavenge.PluginFactory_AuxiliaryImageHeap',
                'com.oracle.svm.core.genscavenge.PluginFactory_GCImpl',
                'com.oracle.svm.core.genscavenge.PluginFactory_HeapImpl',
                'com.oracle.svm.core.genscavenge.PluginFactory_HeapParameters',
                'com.oracle.svm.core.genscavenge.PluginFactory_ObjectHeaderImpl',
                'com.oracle.svm.core.genscavenge.PluginFactory_ThreadLocalAllocation',
                'com.oracle.svm.core.genscavenge.PluginFactory_UnalignedHeapChunk',
                'com.oracle.svm.core.genscavenge.graal.PluginFactory_BarrierSnippets',
                'com.oracle.svm.core.genscavenge.graal.nodes.PluginFactory_FormatArrayNode',
                'com.oracle.svm.core.genscavenge.graal.nodes.PluginFactory_FormatObjectNode',
                'com.oracle.svm.core.genscavenge.remset.PluginFactory_AlignedChunkRememberedSet',
                'com.oracle.svm.core.genscavenge.remset.PluginFactory_RememberedSet',
                'com.oracle.svm.core.genscavenge.remset.PluginFactory_UnalignedChunkRememberedSet',
                'com.oracle.svm.core.graal.aarch64.PluginFactory_AArch64CalleeSavedRegisters',
                'com.oracle.svm.core.graal.amd64.PluginFactory_AMD64CalleeSavedRegisters',
                'com.oracle.svm.core.graal.jdk.PluginFactory_SubstrateArraycopySnippets',
                'com.oracle.svm.core.graal.jdk.PluginFactory_SubstrateObjectCloneSnippets',
                'com.oracle.svm.core.graal.nodes.PluginFactory_KillMemoryNode',
                'com.oracle.svm.core.graal.nodes.PluginFactory_MethodReturnNode',
                'com.oracle.svm.core.graal.nodes.PluginFactory_NewStoredContinuationNode',
                'com.oracle.svm.core.graal.nodes.PluginFactory_WriteCurrentVMThreadNode',
                'com.oracle.svm.core.graal.nodes.PluginFactory_WriteHeapBaseNode',
                'com.oracle.svm.core.graal.nodes.PluginFactory_WriteReturnAddressNode',
                'com.oracle.svm.core.graal.snippets.PluginFactory_ArithmeticSnippets',
                'com.oracle.svm.core.graal.snippets.PluginFactory_CEntryPointSnippets',
                'com.oracle.svm.core.graal.snippets.PluginFactory_DeoptTester',
                'com.oracle.svm.core.graal.snippets.PluginFactory_SafepointSnippets',
                'com.oracle.svm.core.graal.snippets.PluginFactory_StackOverflowCheckSnippets',
                'com.oracle.svm.core.graal.snippets.PluginFactory_SubstrateAllocationSnippets',
                'com.oracle.svm.core.graal.snippets.PluginFactory_SubstrateIntrinsics',
                'com.oracle.svm.core.graal.snippets.aarch64.PluginFactory_AArch64ArithmeticSnippets',
                'com.oracle.svm.core.graal.stackvalue.PluginFactory_StackValueNode',
                'com.oracle.svm.core.headers.PluginFactory_LibC',
                'com.oracle.svm.core.heap.PluginFactory_Heap',
                'com.oracle.svm.core.heap.PluginFactory_ReferenceAccess',
                'com.oracle.svm.core.heap.PluginFactory_ReferenceAccessImpl',
                'com.oracle.svm.core.heap.PluginFactory_ReferenceHandler',
                'com.oracle.svm.core.heap.PluginFactory_StoredContinuationImpl',
                'com.oracle.svm.core.hub.PluginFactory_LayoutEncoding',
                'com.oracle.svm.core.hub.PluginFactory_PredefinedClassesSupport',
                'com.oracle.svm.core.identityhashcode.PluginFactory_SubstrateIdentityHashCodeSnippets',
                'com.oracle.svm.core.jdk.PluginFactory_RuntimeSupport',
                'com.oracle.svm.core.jdk.PluginFactory_Target_java_security_AccessControlContext',
                'com.oracle.svm.core.jdk.management.PluginFactory_ManagementSupport',
                'com.oracle.svm.core.log.PluginFactory_Log',
                'com.oracle.svm.core.meta.PluginFactory_ObjectConstantEquality',
                'com.oracle.svm.core.monitor.PluginFactory_MonitorSnippets',
                'com.oracle.svm.core.monitor.PluginFactory_MonitorSupport',
                'com.oracle.svm.core.nodes.PluginFactory_CFunctionEpilogueNode',
                'com.oracle.svm.core.nodes.PluginFactory_CFunctionPrologueDataNode',
                'com.oracle.svm.core.nodes.PluginFactory_CFunctionPrologueNode',
                'com.oracle.svm.core.nodes.PluginFactory_CodeSynchronizationNode',
                'com.oracle.svm.core.nodes.PluginFactory_SafepointCheckNode',
                'com.oracle.svm.core.option.PluginFactory_HostedOptionKey',
                'com.oracle.svm.core.option.PluginFactory_RuntimeOptionKey',
                'com.oracle.svm.core.option.PluginFactory_RuntimeOptionParser',
                'com.oracle.svm.core.option.PluginFactory_RuntimeOptionValues',
                'com.oracle.svm.core.os.PluginFactory_AbstractCommittedMemoryProvider',
                'com.oracle.svm.core.os.PluginFactory_AbstractRawFileOperationSupport',
                'com.oracle.svm.core.os.PluginFactory_CommittedMemoryProvider',
                'com.oracle.svm.core.os.PluginFactory_ImageHeapProvider',
                'com.oracle.svm.core.os.PluginFactory_IsDefined',
                'com.oracle.svm.core.os.PluginFactory_MemoryProtectionKeyProvider',
                'com.oracle.svm.core.os.PluginFactory_RawFileOperationSupport',
                'com.oracle.svm.core.os.PluginFactory_VirtualMemoryProvider',
                'com.oracle.svm.core.posix.pthread.PluginFactory_PthreadVMLockSupport',
                'com.oracle.svm.core.stack.PluginFactory_StackOverflowCheck',
                'com.oracle.svm.core.thread.PluginFactory_JavaContinuations',
                'com.oracle.svm.core.thread.PluginFactory_JavaThreads',
                'com.oracle.svm.core.thread.PluginFactory_ParkEventList',
                'com.oracle.svm.core.thread.PluginFactory_Safepoint',
                'com.oracle.svm.core.thread.PluginFactory_ThreadListenerSupport',
                'com.oracle.svm.core.thread.PluginFactory_ThreadingSupportImpl',
                'com.oracle.svm.core.thread.PluginFactory_VMOperationControl',
                'com.oracle.svm.core.thread.PluginFactory_VMThreads',
                'com.oracle.svm.core.util.PluginFactory_ByteArrayReader',
                'com.oracle.svm.core.util.PluginFactory_NonmovableByteArrayReader',
                'com.oracle.svm.core.windows.PluginFactory_WindowsVMLockSupport',
                'com.oracle.svm.hosted.image.PluginFactory_NativeImageHeap',
                'com.oracle.svm.jni.PluginFactory_JNIObjectHandles',
                'com.oracle.svm.jni.access.PluginFactory_JNIAccessFeature',
                'com.oracle.svm.reflect.target.PluginFactory_MethodMetadataDecoderImpl',
                'com.oracle.svm.truffle.api.PluginFactory_SubstrateThreadLocalHandshakeSnippets',
                'com.oracle.svm.truffle.api.PluginFactory_SubstrateTruffleOptions';
        provides 'org.apache.xmlbeans.impl.store.QueryDelegate.QueryInterface' with 'org.apache.xmlbeans.impl.xquery.saxon.XBeansXQuery';
        provides 'org.apache.xmlbeans.impl.store.PathDelegate.SelectPathInterface' with 'org.apache.xmlbeans.impl.xpath.saxon.XBeansXPath';
    }

}